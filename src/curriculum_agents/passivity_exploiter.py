"""
PassivityExploiter: Boosts to +6 if not pressured.
Teaches the agent to maintain pressure.
"""

from poke_env.battle import AbstractBattle

from .base import BaseCurriculumPlayer
from ..utils import MoveClassifier


class PassivityExploiter(BaseCurriculumPlayer):
    """
    Boosts to +6 if opponent is passive.
    
    BEHAVIOR:
    - If we have a boost move: Use it (up to +6)
    - Otherwise: Click strongest move
    LESSON: Agent learns to punish passive play.
    EXPLOITABLE BY: Attacking instead of switching.
    """
    
    BOOST_MOVES = MoveClassifier.BOOST_MOVES
    
    def choose_move(self, battle: AbstractBattle):
        active = battle.active_pokemon
        
        # Check if we can still boost
        if active and not self._maxed_out(active):
            boost_move = self._get_boost_move(battle)
            if boost_move:
                return self.create_order(boost_move)
        
        # Max boosts or no boost move: attack
        return self._click_best_move(battle)
    
    def _maxed_out(self, pokemon) -> bool:
        """Check if already at +6 in any relevant stat (including defenses)."""
        boosts = pokemon.boosts
        # Check all stats that we might want to boost
        relevant_stats = ['atk', 'def', 'spa', 'spd', 'spe']
        current_boosts = [boosts.get(s, 0) for s in relevant_stats]
        return max(current_boosts) >= 6
    
    def _get_boost_move(self, battle: AbstractBattle):
        """Get a stat-boosting move."""
        for move in battle.available_moves:
            if move.id.lower() in self.BOOST_MOVES:
                return move
        return None
